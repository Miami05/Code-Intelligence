pipeline {
    agent any

    environment {
        CODE_INTEL_URL  = credentials('code-intel-url')
        CODE_INTEL_REPO = credentials('code-intel-repo-id')
        SLACK_WEBHOOK   = credentials('slack-webhook-url')
    }

    stages {
        stage('Quality Gate') {
            steps {
                script {
                    def resp = sh(
                        script: """curl -s -X POST '${CODE_INTEL_URL}/api/cicd/quality-gate/${CODE_INTEL_REPO}/check' -H 'Content-Type: application/json'""",
                        returnStdout: true
                    ).trim()

                    def result = readJSON text: resp
                    echo "Quality Gate: ${result.passed ? 'PASSED ✅' : 'FAILED ❌'}"
                    echo result.summary

                    env.GATE_PASSED = result.passed.toString()
                    env.RUN_ID = result.run_id ?: ''

                    if (!result.passed && result.block_merge) {
                        error("Quality gate failed — pipeline blocked")
                    }
                }
            }
        }

        stage('Notify') {
            steps {
                sh """curl -s -X POST '${CODE_INTEL_URL}/api/cicd/notify/slack' \
                    -H 'Content-Type: application/json' \
                    -d '{"repository_id":"${CODE_INTEL_REPO}","webhook_url":"${SLACK_WEBHOOK}"}'"""
            }
        }
    }

    post {
        always {
            script {
                if (env.RUN_ID) {
                    echo "Report: ${CODE_INTEL_URL}/api/cicd/report/${env.RUN_ID}"
                }
            }
        }
    }
}

